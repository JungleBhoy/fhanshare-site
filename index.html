<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CardShare - Secure Seat Sharing for Celtic FC</title>
  <meta name="description" content="Secure, fan-first mobile app for Celtic FC season ticket holders to share their matchday seat with trusted contacts using time-limited QR codes.">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">CardShare</a>
      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
      <nav id="nav">
        <a href="index.html" class="active">Home</a>
        <a href="story.html">Our Story</a>
        <a href="press.html">Press</a>
        <a href="for-clubs.html">For Clubs</a>
      </nav>
    </div>
  </header>

  <main>
    <h1 class="page-title">Secure Seat Sharing</h1>
    <p class="page-subtitle">Share your Celtic FC season ticket safely with trusted contacts</p>

    <div class="card">
      <div class="security-indicator">
        <span class="security-icon">üîí</span>
        <span>End-to-end encrypted ‚Ä¢ Time-limited ‚Ä¢ Anti-scalping protected</span>
      </div>

      <div class="form-group">
        <label for="card">Season Card Information:</label>
        <input type="text" id="card" placeholder="e.g. 123456 Block 7 Row G Seat 42" required />
      </div>

      <div class="form-group">
        <label for="email">Your Registered Email:</label>
        <input type="email" id="email" placeholder="your.email@example.com" required />
      </div>

      <div class="form-group">
        <label for="phone">Mobile Number (Verification):</label>
        <input type="tel" id="phone" placeholder="+44 7XXX XXX XXX" required />
      </div>

      <div class="form-group">
        <label for="recipient">Recipient Name:</label>
        <input type="text" id="recipient" placeholder="Full name of person receiving seat" required />
      </div>

      <div class="form-group">
        <label for="recipientPhone">Recipient Mobile:</label>
        <input type="tel" id="recipientPhone" placeholder="+44 7XXX XXX XXX" required />
      </div>

      <div class="form-group">
        <label for="pin">Create 4-digit Security PIN:</label>
        <input type="password" id="pin" maxlength="4" placeholder="e.g. 1967" pattern="[0-9]{4}" required />
      </div>

      <div class="form-group">
        <label for="matchDate">Match Date:</label>
        <input type="date" id="matchDate" required />
      </div>

      <button class="btn" onclick="prepareSecureTransfer()">Generate Secure Transfer</button>
    </div>

    <div id="unlockSection" class="card" style="display: none;">
      <h3>üîì Unlock Your QR Code</h3>
      <p>Enter your PIN or registered email to unlock the transfer code:</p>
      
      <div class="form-group">
        <input type="text" id="unlockKey" placeholder="Enter PIN or Email" />
      </div>
      
      <button class="btn btn-secondary" onclick="unlockTransfer()">Unlock Transfer</button>
      
      <div id="securityTimer" class="security-indicator" style="display: none;">
        <span class="security-icon">‚è±Ô∏è</span>
        <span id="timerText">Code expires in: <span id="countdown"></span></span>
      </div>
    </div>

    <div id="messageArea"></div>
    <div id="qrArea"></div>

    <!-- Anti-Scalping Information -->
    <div class="card">
      <h3>üõ°Ô∏è Anti-Scalping Protection</h3>
      <ul style="text-align: left; color: #666; line-height: 1.8;">
        <li>‚úÖ Time-limited codes (expire 2 hours before kick-off)</li>
        <li>‚úÖ Recipient verification required at gate</li>
        <li>‚úÖ Original holder details logged for security</li>
        <li>‚úÖ One-time use only - cannot be duplicated</li>
        <li>‚úÖ Club steward verification system integrated</li>
      </ul>
    </div>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-links">
        <a href="story.html">Our Story</a>
        <a href="press.html">Press Kit</a>
        <a href="for-clubs.html">For Clubs</a>
        <a href="mailto:support@cardshare.app">Support</a>
      </div>
      <div class="copyright">
        <p>&copy; 2025 CardShare | Built for fans, by fans | Faithful Through & Through</p>
      </div>
    </div>
  </footer>

  <script>
    let secureTransferData = {};
    let countdownInterval;

    function toggleMobileMenu() {
      const nav = document.getElementById('nav');
      nav.classList.toggle('active');
    }

    function validateForm() {
      const card = document.getElementById("card").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const recipient = document.getElementById("recipient").value.trim();
      const recipientPhone = document.getElementById("recipientPhone").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const matchDate = document.getElementById("matchDate").value;

      if (!card || !email || !phone || !recipient || !recipientPhone || pin.length !== 4 || !matchDate) {
        return false;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        return false;
      }

      // Validate phone format (basic)
      const phoneRegex = /^\+?[\d\s-()]+$/;
      if (!phoneRegex.test(phone) || !phoneRegex.test(recipientPhone)) {
        return false;
      }

      // Validate PIN is numeric
      if (!/^\d{4}$/.test(pin)) {
        return false;
      }

      // Validate match date is in the future
      const selectedDate = new Date(matchDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      if (selectedDate <= today) {
        return false;
      }

      return true;
    }

    function prepareSecureTransfer() {
      if (!validateForm()) {
        showMessage("‚ùå Please fill in all fields correctly. PIN must be 4 digits, and match date must be in the future.", "error");
        return;
      }

      const card = document.getElementById("card").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const recipient = document.getElementById("recipient").value.trim();
      const recipientPhone = document.getElementById("recipientPhone").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const matchDate = document.getElementById("matchDate").value;

      // Calculate expiry (2 hours before match)
      const matchDateTime = new Date(matchDate + 'T15:00:00'); // Assume 3pm kick-off
      const expiryTime = new Date(matchDateTime.getTime() - (2 * 60 * 60 * 1000));

      const transferData = {
        id: generateTransferId(),
        card,
        holderEmail: email,
        holderPhone: phone,
        recipient,
        recipientPhone,
        pin,
        matchDate,
        expiryTime: expiryTime.toISOString(),
        createdAt: new Date().toISOString(),
        status: 'pending_unlock'
      };

      secureTransferData = { 
        payload: transferData, 
        unlocked: false,
        attempts: 0,
        maxAttempts: 3
      };

      document.getElementById("unlockSection").style.display = "block";
      showMessage("üîí Secure transfer prepared. Please unlock below to generate your QR code.", "warning");
      
      // Scroll to unlock section
      document.getElementById("unlockSection").scrollIntoView({ behavior: 'smooth' });
    }

    function unlockTransfer() {
      const key = document.getElementById("unlockKey").value.trim();
      const { holderEmail, pin } = secureTransferData.payload || {};

      secureTransferData.attempts++;

      if (secureTransferData.attempts > secureTransferData.maxAttempts) {
        showMessage("‚ùå Too many failed attempts. Please refresh and try again.", "error");
        return;
      }

      if (key === holderEmail || key === pin) {
        generateQRCode();
        startExpiryCountdown();
        showMessage("‚úÖ Transfer unlocked successfully! QR code generated.", "success");
        document.getElementById("unlockSection").style.display = "none";
      } else {
        const remaining = secureTransferData.maxAttempts - secureTransferData.attempts;
        showMessage(`‚ùå Incorrect PIN or Email. ${remaining} attempts remaining.`, "error");
      }
    }

    function generateQRCode() {
      const qrData = {
        ...secureTransferData.payload,
        unlockTime: new Date().toISOString(),
        signature: generateSignature(secureTransferData.payload)
      };

      QRCode.toCanvas(document.createElement('canvas'), JSON.stringify(qrData), {
        width: 300,
        margin: 2,
        color: {
          dark: '#006400',
          light: '#FFFFFF'
        }
      }, function (err, canvas) {
        if (err) {
          showMessage("‚ùå Error generating QR code. Please try again.", "error");
          return;
        }
        
        const qrArea = document.getElementById("qrArea");
        qrArea.innerHTML = `
          <div class="card">
            <h3>üé´ Your Secure Transfer Code</h3>
            <div style="margin: 1rem 0;"></div>
            <p><strong>Recipient:</strong> ${secureTransferData.payload.recipient}</p>
            <p><strong>Match Date:</strong> ${new Date(secureTransferData.payload.matchDate).toLocaleDateString()}</p>
            <p><strong>Expires:</strong> ${new Date(secureTransferData.payload.expiryTime).toLocaleString()}</p>
            <div style="margin: 2rem 0; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
              <p style="margin-bottom: 1rem; font-weight: 600;">‚ö†Ô∏è Important Instructions:</p>
              <ul style="text-align: left; color: #666;">
                <li>Show this QR code to stadium security</li>
                <li>Recipient must bring photo ID</li>
                <li>Code expires 2 hours before kick-off</li>
                <li>One-time use only</li>
              </ul>
            </div>
          </div>
        `;
        qrArea.querySelector('div').insertBefore(canvas, qrArea.querySelector('p'));
        
        // Scroll to QR code
        qrArea.scrollIntoView({ behavior: 'smooth' });
      });
    }

    function startExpiryCountdown() {
      const expiryTime = new Date(secureTransferData.payload.expiryTime);
      const timerElement = document.getElementById("securityTimer");
      const countdownElement = document.getElementById("countdown");
      
      timerElement.style.display = "flex";
      
      countdownInterval = setInterval(() => {
        const now = new Date();
        const timeLeft = expiryTime - now;
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          countdownElement.textContent = "EXPIRED";
          showMessage("‚è∞ QR code has expired. Please generate a new one.", "error");
          return;
        }
        
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        countdownElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
      }, 1000);
    }

    function generateTransferId() {
      return 'CS' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    function generateSignature(data) {
      // Simple signature for demo - in production this would use proper cryptographic signing
      return btoa(JSON.stringify(data)).slice(-16);
    }

    function showMessage(text, type) {
      const messageArea = document.getElementById("messageArea");
      messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          messageArea.innerHTML = '';
        }, 5000);
      }
    }

    // Set minimum date to today
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('matchDate').setAttribute('min', today);
    });

    // Real-time validation feedback
    document.getElementById('pin').addEventListener('input', function(e) {
      const pin = e.target.value;
      if (pin.length === 4 && /^\d{4}$/.test(pin)) {
        e.target.style.borderColor = '#28a745';
      } else {
        e.target.style.borderColor = '#dc3545';
      }
    });

    document.getElementById('email').addEventListener('input', function(e) {
      const email = e.target.value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (emailRegex.test(email)) {
        e.target.style.borderColor = '#28a745';
      } else {
        e.target.style.borderColor = '#dc3545';
      }
    });
  </script>
</body>
</html>